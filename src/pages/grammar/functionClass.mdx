import { Pitfall, Note } from '@/components/callout';



# Function And Class



## Tail Position Calls

尾调用简单来说是在一个函数的尾部（一定是函数最后一步）调用另一个函数。

尾调用存在意义是为了减少调用栈大小，从而减少内存消耗。

一般来讲，每调用一次函数的时候，其上下文就会被记录在调用栈中，如果该函数调用结束且其中的变量没有被引用
时，其上下文就会从调用栈中弹出，从而销毁其占用的内存空间。

如果调用栈中记录了较多的上下文，那么就会有可能发生“栈溢出”，消耗大量的内存。

**因此就会出现尾调用优化（Tail call optimization）**，在递归中表现尤其明显

<Pitfall>
  基于上述原因，尾调用优化就是将调用栈中的上下文始终保持在当前上下文中，这样消耗的内存资源就会很少。
  而要处理这样的优化，就要在函数最后一次操作中只调用函数且将在下一次函数调用所需要的值按传参的方式传递下去，
  这样当前调用栈就不会记录被引用的变量了，
</Pitfall>


### SS-IsInTailPosition(call)

Static Semantics IsInTailPosition 抽象操作符接收参数*call*(a CallExpression Parse Node,
a MemberExpression Parse Node, or an OptionalChain Parse Node)，并且返回一个Boolean, 执行
以下步骤：

```md
1. If IsStrict(call) is false, return false.
2. If call is not contained within a FunctionBody, a ConciseBody, or an AsyncConciseBody, return false.
3. Let body be the FunctionBody, ConciseBody, or AsyncConciseBody that most closely contains call.
4. If body is the FunctionBody of a GeneratorBody, return false.
5. If body is the FunctionBody of an AsyncFunctionBody, return false.
6. If body is the FunctionBody of an AsyncGeneratorBody, return false.
7. If body is an AsyncConciseBody, return false.
8. Return the result of HasCallInTailPosition of body with argument call.
```

<Note>
  尾部位置调用仅在严格模式代码中定义，因为通用的非标准语言扩展允许观察调用者上下文链。
</Note>

### SS-HasCallInTailPosition

Static Semantics IsInTailPosition **语法导向操作符**接收参数*call*(a CallExpression Parse Node,
a MemberExpression Parse Node, or an OptionalChain Parse Node)，并且返回一个Boolean

具体算法操作见[规范](https://tc39.es/ecma262/#sec-static-semantics-hascallintailposition)


### PrepareForTailCall

抽象操作PrepareForTailCall不接受任何参数，并返回未使用的参数。调用时执行以下步骤：

1. assert：当前执行上下文随后将不会用于评估任何ECMAScript代码或内置函数。在调用这个抽象操作之后的调用将在执行任何这样的计算之前创建并推送一个新的执行上下文。
2. 丢弃与当前执行上下文相关联的所有资源。
3. Return UNUSED.

**尾部位置调用必须在调用目标函数之前释放与当前正在执行的函数执行上下文相关联的任何瞬时内部资源，或者重用这些资源来支持目标函数。**

<Note>
  例如，尾部位置调用应该只增加实现的激活记录堆栈的数量，即目标函数的激活记录的大小超过调用函数的激活记录的大小。如果目标函数的激活记录较小，那么堆栈的总大小应该会减小。
</Note>

### Reference

- [尾调用优化](https://www.ruanyifeng.com/blog/2015/04/tail-call.html)

